<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    {% include 'bootstrap.css.frag' %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>
    {% include 'header.frag.html' %}

    <main>
        <div class="container">
            {% include 'flashed_messages.frag.html' %}

            <form action="/api/users/create" method="post" class="mb-3 row g-2 align-items-end">
                <div class="col-auto">
                    <label for="add-user-id" class="form-label">User ID</label>
                    <input id="add-user-id" name="user" type="number" class="form-control" required>
                </div>
                <div class="col-auto">
                    <label for="add-user-name" class="form-label">Name</label>
                    <input id="add-user-name" name="name" class="form-control" required>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-outline-success">Add User</button>
                </div>
            </form>

            <table class="table">
                <thead>
                    <tr>
                        <th scope="col">User ID</th>
                        <th scope="col">Name</th>
                        <th scope="col">Can Login?</th>
                        <th scope="col">Admin?</th>
                        <th scope="col" colspan="2">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr data-user="{{ user.user }}">
                        <th scope="row">{{ user.user }}</th>
                        <td>
                            <input type="text" name="name" class="form-control" value="{{ user.name }}">
                        </td>
                        {% if "password" in user %}
                        <td class="text-success"><i class="bi bi-check-circle-fill"></i> True</td>
                        {% else %}
                        <td><i class="bi bi-x"></i> False</td>
                        {% endif %}
                        {% if user.scopes and "admin" in user.scopes %}
                        <td class="text-success"><i class="bi bi-check-circle-fill"></i> True</td>
                        {% else %}
                        <td><i class="bi bi-x"></i> False</td>
                        {% endif %}
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="updateUser(this)">Save</button>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteUser(this)">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <script>
        async function updateUser(button) {
            const tr = button.closest("tr");
            const userId = parseInt(tr.dataset["user"]);
            const nameInput = tr.querySelector('input[name="name"]');

            const body = {
                user: userId,
                name: nameInput.value
            };

            await fetch("/api/users/update", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            location.reload();
        }

        async function deleteUser(button) {
            const tr = button.closest("tr");
            const userId = parseInt(tr.dataset["user"]);

            if (!confirm(`Delete user ${userId}? This cannot be undone.`)) {
                return;
            }

            const body = { user: userId };

            await fetch("/api/users/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            location.reload();
        }
    </script>
</body>

</html>
